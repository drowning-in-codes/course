| 《数据库原理》实验报告      |                |            |      |      |
| --------------------------- | -------------- | ---------- | ---- | ---- |
| 题目：实验八 数据库综合实验 | 学号2019301452 | 姓名舒秋豪 | 班级 | 日期 |
|                             |                |            |      |      |

## 一. 实验内容、步骤以及结果

### 实验目的

通过完成从用户需求分析、概念结构设计、逻辑结构设计等一系列的数据库设计到编程、调试和应用等全过程，进一步理解和掌握教材中的相关内容。

### 实验步骤

(1) 先对选定的实验做简单的需求分析。

(2) 做出数据流图和数据字典。

(3) 在数据流图和字典的基础上做出E-R图(概念结构设计)。

(4) 在E-R图基础上进行关系模式设计（至少满足3NF）（逻辑结构设计）。

(5) 根据需求分析中的各种数据请求得出各种视图以及各种约束、规则、触发器脚本描述。

(6) 根据第(5)的内容在MySQL, SQLServer等中设计中数据库。

(7) 用自己熟悉的一门语言进行设计的功能的实现，必须包括对数据的查询、增加、修改和删除。

(8) 整理前面几步的文档和程序源码，可执行程序。

(9) 实验报告的最后写出本次实验完成中遇到的问题及解决方法。

### 具体步骤

本次实验我选用图书管理系统作为数据库设计对象.

#### 需求分析阶段

> 一个简单的图书管理系统包括图书馆内书籍的信息、学校在校学生的信息以及学生的借阅信息。此系统功能分为面向学生和面向管理员两部分，其中面向学生部分可以进行借阅、续借、归还和查询书籍等操作；面向管理员部分可以完成书籍和学生的增加、删除和修改以及对学生借阅、续借、归还的确认。

​	先进行需求分析,根据图书管理系统所给含义,该系统包含书籍信息,即有书籍实体,学校在校学生信息,即拥有学生实体,此外还有借阅信息.学生借阅,归还等会增加借阅信息.同时,系统功能对于学生和管理员不同,他们所面向的数据集不同.学生主要是对书籍的操作,管理员不仅可以对学生,书籍进行操作,还会审核学生借阅信息.

​	然后根据分析作出数据字典以及数据流.

#### 概念结构设计阶段

> **数据字典（data dictionary）**是对于数据模型中的数据对象或者项目的描述的集合，这样做有利于程序员和其他需要参考的人。
>
> 数据字典包括**数据流字典、数据存储字典、数据处理字典、数据项字典**

学生信息 

数据项={学号,表明学生信息,varchar(10)} {姓名,学生姓名,varchar(5)}

{借阅过的书籍数,包含之前借阅的书籍,int}		{名下的书籍数,现有的书籍数,int}	

书籍信息 

数据项={书名,varchar(20)}  {ISBN号,唯一标明书籍信息,varchar(13)}

​       {作者,varchar(10)}  {出版时间,datetime} {剩余数量,int}

借阅信息

数据项={学号,ISBN,书名,借阅时间,归还时间,是否续借,借阅数量} 

管理员

数据项={账号,varchar(10)}  

**两种角色图**

<img src="https://gitee.com/the-helpless-beggar/mypics/raw/master/image-20211113103415262.png" alt="image-20211113103415262" style="zoom:80%;" />

> 数据流是数据结构在系统内传输的路径

> 数据流图(DFD)是结构化分析方法中使用的工具,它以图形的方式描绘数据在系统中流动和处理的过程，
>
> 因为它仅仅反映系统必须完毕的逻辑功能。所以它是一种功能模型。
>
> 在结构化开发方法中。数据流图是需求分析阶段产生的结果



<img src="https://gitee.com/the-helpless-beggar/mypics/raw/master/image-20211113103234957.png" alt="image-20211113103234957" style="zoom:67%;" />



接下来开始概念设计

<img src="https://gitee.com/the-helpless-beggar/mypics/raw/master/image-20211113110949630.png" alt="image-20211113110949630" style="zoom:67%;" />

E-R图

#### 逻辑结构设计阶段

**学生信息表**

```mysql
create table student(
sno varchar(10) primary key, -- 学生学号 主键 
sname varchar(10),  -- 学生名字 
major varchar(10), -- 专业 
books int, -- 借阅的书籍数量 (不包含归还) 
s_password varchar(10) -- 登陆系统的密码 
);
```

可以看到有一个细节,有一个密码字段用于检验登录

**书籍信息表**

```mysql
create table books(
isbn varchar(13) primary key, -- isbn号 主键 
b_name varchar(15),-- 书名 
b_publish_time date,  -- 出版时间 
b_author varchar(10),  -- 作者 
b_num int, -- 书的数量 
b_pop int -- 受欢迎程度  这里定义为这种书被借阅过的次数
);
```

**管理员信息表**

```mysql
create table administer(
a_name varchar(10) primary key, -- 管理员账号
a_password varchar(10) -- 管理员密码
);
```

同理管理人员登录需要检验,登陆后权限很高,可以查看或修改学生信息.

**租借信息表**

```mysql
create table sb_info(
sno varchar(10), -- 学生学号  外键 
isbn varchar(13),  -- 书籍isbn号 外键
borrow_time datetime, -- 借书时间  这里精确到 秒
back_time datetime, -- 归还时间
borrow_num int, -- 借书的数量
is_back int, -- 添加约束只能为0或1 表示是否归还 
is_con int,  -- 添加约束只能为 0或1 表示是否续租
is_back_allowed int,  -- 添加约束只能为 0或1 表示管理员是否允许归还书
is_allowed int,  -- 添加约束只能为 0或1 表示管理员是否允许租借书
is_con_allowed int,  -- 添加约束只能为 0或1 表示管理员是否允许续租
foreign key(sno) references student(sno),
foreign key(isbn) references books(isbn),
constraint con check(is_con in (0,1)),
constraint back check(is_back in (0,1)),
constraint allowed check(is_allowed in (0,1)),
constraint back_allowed check(is_back_allowed in (0,1)),
constraint con_allowed check(is_con_allowed in (0,1)),
primary key(sno,isbn,borrow_time) -- 设置主键
);
```

学生每租借会向这个表增加一条记录,续租或者归还会更改这个记录相关的值.

比如管理员允许该操作后设置为is_allowed=1,如果归还会将is_back设为1,想要续租设置is_con = 1

**触发器**

```mysql
delimiter //
//
create trigger insert_t after insert on sb_info
for each row
begin
-- update student set books=books+new.borrow_num where student.sno=new.sno;
update books set b_num=b_num-new.borrow_num,b_pop=b_pop+1 where  -- 注意这里增加了书的流行度
books.isbn=new.isbn;
end//
```

为插入学生借阅表创建触发器.当增加数据时表明学生借阅了书籍,则为学生借书数量+借阅的数量,为书本信息表的相关书的数量-借阅的数量,同时书的流行度+1

```mysql
delimiter //
//
create trigger delete_t after delete on sb_info
for each row
begin
update student set books=books-old.borrow_num where student.sno=old.sno;
-- update books set b_num=b_num+old.borrow_num where books.isbn=old.isbn;
end//
```

同理,当删除借阅信息时,书籍的数量+节约的数量,学生的书籍数量-借阅的数量

另外,因为借书,还书需要审核,所以还要创建触发器,当管理员允许时,借书时学生拥有的书增加.换书时图书馆的书才能相加.

```mysql
delimiter //
//
create trigger update_t before update on  sb_info
for each row 
begin
if(new.is_allowed=1 and sno=new.sno) then
update student set books=books+new.borrow_num;
elseif(books.isbn=new.isbn and new.is_back_allowed=1) then
update books set b_num=b_num+new.borrow_num ;
elseif(new.is_con=1 and new.is_con_allowed=1) then
set new.back_time=DATE_ADD(old.back_time,INTERVAL 5 DAY),new.is_con=0;
end if;
end
//
```

注意当学生申请续借书籍且管理员审核通过后,归还时间延长5天(尚未实现灵活增加),同时将学生申请置为0

而且由于使用update更新sb_info的同时触发器也要更新相同表的数据,所以触发器里需要写set

```mysql
delimiter //
//
create trigger delete_back after update on sb_info
for each row
begin
if new.is_back=1 and new.is_back_allowed=1 then
delete from sb_info where is_back=1 and is_back_allowed=1;
end if;
end
//
```

同时当学生归还且管理员允许归还时删除这条记录

![image-20211122121320580](https://gitee.com/the-helpless-beggar/mypics/raw/master/image-20211122121320580.png)



需要设置归还日期,这部分逻辑利用主语言实现

```c#
string sql = "insert into sb_info (sno,isbn,borrow_time,borrow_num,back_time) values (\"{0}\",\"{1}\",\"{2}\",{3},\"{4}\");";
            MySqlCommand cmd = new MySqlCommand(string.Format(sql, this.username, book_sno,DateTime.Now.DateTimeString(),book_num,DateTime.Now.AddDays(Double.Parse(borrow_time)).DateTimeString()), con); //当借书时,归还日期可以用户自己设置
```

当学生申请借阅书籍时,归还日期设置为当前时间+学生设置的借阅天数.

同时,学生借阅天数不能过长

```c#
 private void uiComboBox2_TextChanged(object sender, EventArgs e)
        {
            int num = 1;
            try
            {
                num = int.Parse(this.uiComboBox2.Text);
            }
            catch(Exception ex)
            {
                UIMessageTip.ShowError("输入错误" + ex.Message);
                this.uiComboBox2.Text = "1";
            }
            if (num>40)
            {
                UIMessageTip.ShowWarning("您借书的时间未免太长了");
                this.uiComboBox2.Text = "1";
            }
            
        }
```

当学生借阅书籍却仍未归还,则显示提示信息.

利用主代码实现当当前日期超过归还日期,每过一段时间会进行提示

```mysql
 private void timer2_Tick(object sender, EventArgs e)
        {
            string sql = "select back_time from student,books,sb_info where student.sno=sb_info.sno and books.isbn=sb_info.isbn and is_back=0 and is_back_allowed=0 and borrow_num>0;";
            MySqlCommand cmd = new MySqlCommand(sql, con);
            MySqlDataReader dr = null;
            try
            {
              dr =  cmd.ExecuteReader();
            }
            catch(Exception ex)
            {
                UIMessageBox.ShowError("连接出错,请检查连接"+ex.Message);
                this.Close();
            }
            while(dr.Read())
            {
                if (dr[0] != DBNull.Value)
                {
                    DateTime dt = Convert.ToDateTime(dr[0]);
                    if (DateTime.Compare(DateTime.Now, dt) > 0)
                    {
                        UIMessageBox.ShowInfo("您书籍归还日期已到,请及时归还!!");
                        break;
                    }
                  
                }
            }
            dr.Close();
        }
```



**视图**

同时创建视图,用于查看学生所借阅的书籍

```mysql
create view stu_sb as 
select student.sno as sno,books.isbn as isbn,borrow_num,borrow_time,back_time,b_name,is_back,is_back_allowed from student,books,sb_info where (student.sno=sb_info.sno and books.isbn=sb_info.isbn and borrow_num>0 and is_allowed=1) and (is_back=0 or ( is_back = 1 and is_back_allowed=0));
```

可以看到这个视图将未归还书籍以及未允许归还书籍,借阅数量>0书籍并且允许借阅的选择出来,用于用户查看

还有学生可以看见的书籍,即库存>0的书籍

```mysql
create view avai_book as (
select * from books where b_num>0
);
```

**索引**

为经常选取的数据增加索引





#### 物理结构设计阶段

使用Mysql作为DBMS,引擎为Innodb







运行结果：

 

 

**tips**

学生以及管理员拥有修改密码权限,管理员不仅能修改自己密码,还能修改学生密码.





二. 实验中出现的问题以及解决方案(对于未解决问题请将问题列出来)

除了标题内容以外，该部分内容中还可以写对于实验的一些感受，建议，意见等。

触发器报错

数据冗余

触发器,视图等某些信息冗余

c#代码有待重构

逻辑

DBnull

传参

[MySQL Trigger cannot update table - getting ERROR 1442 - Stack Overflow](https://stackoverflow.com/questions/12203859/mysql-trigger-cannot-update-table-getting-error-1442/27599385#27599385)